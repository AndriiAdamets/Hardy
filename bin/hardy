#!/usr/bin/env node

//Usage:
// hardy --browser=chrome,phantomjs,ie features/
// hardy selenium start
// hardy selenium stop
// hardy init

var http = require("http"),
    fs = require('fs'),
    path = require('path'),
    spawn = require('child_process').spawn,
    VERSION = require('../package.json').version,
    PROPERTIES = {
        "browser": "firefox"
    },
    browsersToTest,
    testFolder,
    numberOfRuns, currentRun,
    exitCode,
    seleniumLocked, seleniumPID,
    hardyPath = path.resolve(require.main.filename, '../..') + '/',
    testPath,
    lockFile = hardyPath + '.seleniumlock';

console.log('Hardy v' + VERSION);

// Cannot run hardy without arguments
if (process.argv.length < 3) {
    usage();

} else {

    // If this is simply a call to initialise the current directory with default test setup
    if (process.argv[2] === 'init') {

        // Check it hasn't already fot files in it
        if(fs.existsSync('selectors/') || fs.existsSync('screenshots/')) {
            console.log('Cannot init a non-empty directory');
            process.exit(1);

        // If the directory is empty, create the default empty files
        } else {
            fs.writeFile('test.feature', "", function(err) {
                if (err) {
                    console.log(err);
                } else {
                    fs.mkdirSync('selectors');
                    fs.mkdirSync('screenshots');
                    fs.writeFile('selectors/selectors.js', "module.exports = {};", function(err) {
                        if (err) {
                            console.log(err);
                        } else {
                            console.log("Test folder created");
                            process.exit(0);
                        }
                    });
                    process.exit(0);
                }
            });
        }

    // Not just initialising a new folder
    } else {

        //First check if Selenium is running
        http.get("http://127.0.0.1:4444/wd/hub", function(res) {
            // Selenium is running

            // is this our Selenium?
            seleniumLocked = fs.existsSync(lockFile);
            if (seleniumLocked) {
                seleniumPID = fs.readFileSync(lockFile);
            } else {
                console.log('Using external selenium.');
            }

            // is this a call to stop selenium?
            if (process.argv[2] === 'selenium') {
                if (process.argv[3] === 'stop') {
                    if (seleniumLocked) {
                        fs.unlinkSync(lockFile);
                        process.kill(seleniumPID, 'SIGHUP');
                        console.log('Selenium stopped');
                    } else {
                        console.log('Cannot control external Selenium');
                    }
                // Is it a call to start selenium (even though it is already running)
                } else if (process.argv[3] === 'start') {
                    console.log('Selenium already running [' + seleniumPID + ']');

                // command is 'hardy selenium somethingElse', Ignore.
                } else {
                    usage();
                }

            } else {
                process.argv.forEach(function(arg) {
                    arg = arg.match(/^--([A-Za-z]+)=(.*)/);

                    // Only look for --[PROPERTY] style args, everything else can be forgotten
                    if (arg === null || !arg[1]) return;


                    // If the JSON file has the argument to override, then override it.
                    if (PROPERTIES.hasOwnProperty(arg[1])) {
                        PROPERTIES[arg[1]] = arg[2];

                        // Otherwise proclaim that it is an unrecognised argument
                    } else {
                        console.log('Unrecognised argument ' + arg[1]);
                    }

                });

                testFolder = process.argv[process.argv.length - 1];
                testPath = path.resolve(testFolder);
                browsersToTest = PROPERTIES.browser.split(',');
                numberOfRuns = browsersToTest.length;
                currentRun = 0;
                exitCode = 0;

                browsersToTest.forEach(function(browser) {
                    var optionsArray = [];

                    // Output style of Cucumber
                    optionsArray.push("-f=progress");

                    // Get Cucumber to load our CSS test helpers and world files first
                    optionsArray.push("-r=" + hardyPath + 'features/');

                    // Now load any test-folder local step files
                    if (fs.existsSync(testPath + "/step_definitions/")) {
                        optionsArray.push("-r=" + testPath + "/step_definitions/");
                    }

                    // Load test-folder local selector mapping files
                    if (fs.existsSync(testPath + "/selectors/")) {
                        optionsArray.push("-r=" + testPath + "/selectors/");
                    }

                    // Set the WebDriverJS logLevel if it has been supplied
                    if (PROPERTIES.logLevel && PROPERTIES.logLevel !== 'silent') {
                        optionsArray.push("--logLevel=" + PROPERTIES.logLevel);
                    }

                    // Need to loop over the specified browsers
                    optionsArray.push("--browser=" + browser);

                    // This is the path to the globally installed Hardy
                    optionsArray.push("--binaryPath=" + hardyPath);

                    // Path to the local test folder
                    optionsArray.push("--testPath=" + testPath);

                    // Where to find our *.feature files
                    optionsArray.push(testPath);


                    // console.log(hardyPath + 'node_modules/.bin/cucumber.js', optionsArray, {
                    //     cwd: testPath,
                    //     stdio: 'inherit'
                    // });

                    // Spawn all the different browsers into separate child processes
                    // but pipe the stdio and stderr back to the parent.
                    var testRun = spawn(hardyPath + 'node_modules/.bin/cucumber.js', optionsArray, {
                        cwd: testPath,
                        stdio: 'inherit'
                    });
                    testRun.on('exit', makeNext(browser));
                });
            }
        }).on('error', function(e) {
            // Selenium is not running, is this a call to start it?
            if (process.argv[2] === 'selenium') {

                // If it isn't running, get rid of any incorrect lockfiles
                seleniumLocked = fs.existsSync(lockFile);
                if (seleniumLocked) {
                    fs.unlinkSync(lockFile);
                }

                if (process.argv[3] === 'start') {
                    var selenium = spawn('java', ['-jar', path + 'bin/selenium-server-standalone-2.32.0.jar']);
                    fs.writeFile(lockFile, selenium.pid, function(err) {
                        if (err) {
                            console.log(err);
                        } else {
                            console.log("Selenium started: [" + selenium.pid + "]");
                            process.exit(1);
                        }
                    });
                } else if (process.argv[3] === 'stop') {
                    console.log('Selenium stopped');
                } else {
                    usage();
                }

            } else {
                console.log("Selenium not running: " + e.message);
                process.exit(1);
            }
        });

    }

}

// Basic usage. Fill out later with:
//Usage:
// hardy --browser=chrome,phantomjs,ie features/
// hardy selenium start
// hardy selenium stop
// hardy init
function usage() {
    console.log('Usage:');
    console.log('hardy --browser=chrome,phantomjs,ie features/');
    process.exit(1);
}

// Helper to make the main thread wait for the children to finish before
// deciding on its own error code.
function makeNext(browser) {
    return function next(code) {
        exitCode += code;
        currentRun++;
        if (code === 0) {
            // Add Browser name here
            console.log(browser + ' success');
        } else {
            console.log(browser + ' fail');
        }
        if (currentRun == numberOfRuns) {
            process.exit(exitCode);
        }
    };
}